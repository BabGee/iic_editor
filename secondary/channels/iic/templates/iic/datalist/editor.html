{% extends 'iic/base.html' %}
{% load static %}

{% block content %}
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/iic_editor/dsc/">Datalists</a></li>
        <li class="breadcrumb-item active">{{ data_list.title }}</li>
    </ol>

    <a href="/admin/dsc/datalist/{{ data_list.pk }}/change/" target="_blank">Datalist Edit</a>
    <a href="/admin/dsc/datalistquery/{{ data_list.query.pk }}/change/" target="_blank">Query Edit</a>
<br>
    <!--

        Data List
            ----------------------------------
            dataname
            status DSC.dataliststatus ACTIVE
        level=0
        title

        --------------------------------
        name
        description
            module
        model
        values
     -->

    <input placeholder="Data Name" name="data_name" type="text" required> <br>
    <input  name="level" type="text" value="0"> <br>

    <input placeholder="Title" name="title" type="text"> <br>


    <p>{{ data_list.query.module_name }} {{ data_list.query.model_name }}</p>

    <label for="module">Module</label>
    <select id="module" name="module">
        {% for node_system in modules %}
                <option {% if node_system.name == data_list.query.module_name|upper %}selected{% endif %}
                        value="{{ node_system.URL }}">{{ node_system.name }}</option>
        {% endfor %}

    </select>

    <label for="model">Model</label>
    <select id="model" name="model"></select>

    <p>Values</p>
    <div id="values">
        {% for value in values %}
            <div>
                <input type="text" value="{{ value.label }}"> :
                <input type="text" value="{{ value.path }}">
            </div>
            {% empty %}
            <p>No Values</p>
        {% endfor %}
    </div>
    <button onclick="textBoxCreate()">Add</button>
    <button id="saveValues">Save</button>
    <br>

    <div id="bloodhound">
      <input class="typeahead" type="text" placeholder="States of USA">
    </div>

    <br>

    <p>Links</p>
    <div id="links">
        {% for link in links %}
            <div>
                <input type="text" value="{{ link.label }}"> :
                <input type="text" value="{{ link.service }}"> :
                <input type="text" value="{{ link.icon }}">
                <!-- TODO add link params -->
            <button >-</button>
            </div>

            {% empty %}
            <p>No links</p>
        {% endfor %}

    </div>
<button onclick="linkInputCreate()">Add</button>
<button id="saveLinks">Save</button>
<br>
{% endblock %}


{% block script %}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
    <script type="text/javascript">
        function textBoxCreate() {
            var container = document.createElement('DIV');
            container.innerHTML = '<input placeholder="label" type="text"> : ' +
                '<input placeholder="Prop Path" type="text">';
            document.getElementById("values").appendChild(container);

        }

        function linkInputCreate() {
            var container = document.createElement('DIV');
            container.innerHTML = '<input placeholder="label" type="text"> : ' +
                '<input placeholder="Service" type="text"> : '+
                '<input placeholder="Icon" type="text">';

            document.getElementById("links").appendChild(container);

        }


            function loadModels(){
                $.ajax({
                    url: "/iic_editor/dsc/models/",
                    beforeSend: function (xhr, settings) {
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }

                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                        }
                        // todo btn.html('<img src="/static/loader.gif">');
                    },
                    data: { module:$('select#module').val()},
                    type: 'GET',
                    success: function (data) {
                       // console.log(data);
                        $('#model').html(data);

                    }
                });
			}

        $(function(){


			$("select#module").change(loadModels);

			// load models from templated selection
			loadModels();

            $("#saveLinks").click(function(){

                var genLinks = [];

                $('#links').children('div').each(function () {
                    console.log(this);
                    var genLink = [];
                    $(this).children('input').each(function () {
                        genLink.push($(this).val())
                    });
                    genLinks.push(genLink.join('%'))
                });

                console.log(genLinks);

                $.ajax({
                    url: "/iic_editor/dsc/{{ data_list.data_name }}/",
                    beforeSend: function (xhr, settings) {
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }

                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                        }
                        // todo btn.html('<img src="/static/loader.gif">');
                    },
                    data: {name:'links', value:genLinks.join('|')},
                    type: 'POST',
                    success: function (data) {
                        console.log(data);

                        // $('#model').html(data);
                    }

                });
			});

            $("#saveValues").click(function(){

                var genLinks = [];

                $('#values').children('div').each(function () {
                    // console.log(this);
                    var genLink = [];
                    $(this).children('input').each(function () {
                        genLink.push($(this).val())
                    });
                    genLinks.push(genLink.join('%'))
                });

                // console.log(genLinks);

                $.ajax({
                    url: "/iic_editor/dsc/{{ data_list.data_name }}/",
                    beforeSend: function (xhr, settings) {
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }

                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                        }
                        // todo btn.html('<img src="/static/loader.gif">');
                    },
                    data: {name:'values', value:genLinks.join('|')},
                    type: 'POST',
                    success: function (data) {
                        console.log(data);

                        // $('#model').html(data);
                    }

                });
			})


             var statesS = ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
                'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii',
                'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
                'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
                'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
                'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota',
                'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island',
                'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
                'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
              ];

             // bloodhound
              // ----------

              // constructs the suggestion engine

              $('#bloodhound .typeahead').typeahead({
                hint: true,
                highlight: true,
                minLength: 1
              },
              {
                name: 'states',
                source: statesS
              });


		})





    </script>
{% endblock %}
